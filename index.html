<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal Trading Pro 7.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.js"></script>
    
    <style>
        :root {
            --bg-color: #0A0A10; --card-color: #1E1E1E; --primary-color: #333333;
            --secondary-color: #00A8FF; --font-color: #E0E0E0; --font-color-muted: #888;
            --border-color: #333333; --success-color: #28a745; --danger-color: #dc3545; --warning-color: #ffc107;
        }

        body.light-mode {
            --bg-color: #F0F2F5; --card-color: #FFFFFF; --primary-color: #E4E6EB;
            --font-color: #050505; --font-color-muted: #65676B; --border-color: #CED0D4;
        }

        body {
            font-family: 'Poppins', sans-serif; background-color: var(--bg-color);
            color: var(--font-color); margin: 0; font-size: 14px; transition: background-color 0.3s, color 0.3s;
        }

        .app-container { display: flex; flex-direction: column; min-height: 100vh; }
        
        .top-bar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 20px; background-color: var(--card-color); border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s, border-bottom 0.3s; position: sticky; top: 0; z-index: 1001;
        }
        .app-title { font-size: 1.2em; font-weight: 600; }
        .app-title span { color: var(--secondary-color); }

        .hamburger-menu { cursor: pointer; padding: 5px; z-index: 2001; }
        .hamburger-menu .bar { display: block; width: 22px; height: 2px; margin: 5px auto; background-color: var(--font-color); transition: all 0.3s ease-in-out; }
        .nav-sidebar {
            position: fixed; top: 0; right: -250px; width: 250px; height: 100%;
            background-color: var(--primary-color); box-shadow: -5px 0 15px rgba(0,0,0,0.5);
            transition: right 0.3s ease-in-out, background-color 0.3s; z-index: 2000; padding-top: 50px;
        }
        .nav-sidebar.active { right: 0; }
        .nav-tab {
            display: flex; align-items: center; gap: 15px; padding: 15px 20px; color: var(--font-color); cursor: pointer;
            text-decoration: none; border-bottom: 1px solid var(--border-color); font-size: 0.9em;
        }
        .nav-tab:hover, .nav-tab.active { background-color: var(--secondary-color); font-weight: 600; }
        
        main { padding: 20px; flex-grow: 1; }
        .page-content { display: none; }
        .page-content.active { display: block; }

        .grid-container, .page-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; max-width: 1600px; margin: auto; }
        .tools-container, .settings-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; max-width: 1200px; margin: auto; }

        .card {
            background-color: var(--card-color); border-radius: 8px; padding: 20px;
            border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; transition: background-color 0.3s, border 0.3s;
            opacity: 0; transform: translateY(10px); animation: fadeIn 0.5s forwards;
        }
        
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 15px; }
        .card h2 { margin: 0; color: var(--secondary-color); font-size: 1em; font-weight: 500; }
        
        .stat-card { text-align: center; }
        .stat-card h3 { margin: 0 0 5px 0; font-size: 0.8em; color: var(--font-color-muted); text-transform: uppercase; }
        .stat-card .value { font-size: 1.6em; font-weight: 600; }
        
        .stat-card .value-split {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            margin-top: 10px;
        }
        .stat-card .value-split > div {
            text-align: center;
        }
        .stat-card .sub-heading {
            margin: 0 0 5px 0;
            font-size: 0.7em;
            color: var(--font-color-muted);
            text-transform: uppercase;
            font-weight: 500;
        }
        .stat-card .value-split .value {
            font-size: 1.2em; /* Slightly smaller */
        }

        .pl-summary .pl-item { margin-bottom: 10px; }
        .pl-summary h4 { margin: 0 0 4px 0; font-size: 0.8em; color: var(--font-color-muted); }
        .pl-summary .pl-value { font-size: 1.2em; font-weight: 500; }

        .button, button {
            padding: 12px; background: linear-gradient(90deg, #00A8FF, #007BFF); color: white;
            border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .button:hover, button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 168, 255, 0.2); }
        .button.secondary { background: var(--primary-color); }
        .button.secondary:hover { background: var(--secondary-color); }
        
        .btn-detail { padding: 5px 10px; font-size: 0.75em; background: var(--primary-color); width: auto; }
        .btn-detail:hover { background: var(--secondary-color); }

        .btn-refresh { padding: 6px; font-size: 0.8em; background: var(--primary-color); width: auto; min-width: 30px; }
        .btn-refresh:hover { background: var(--secondary-color); }
        .btn-refresh .fa-spin { display: none; }
        .btn-refresh.loading .fa-spin { display: inline-block; }
        .btn-refresh.loading .fa-sync { display: none; }

        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; grid-column: 1 / -1; margin-bottom: 20px; }
        .portfolio-section { grid-column: 1 / 4; }
        .pl-section { grid-column: 4 / 5; }
        .chart-section { grid-column: 1 / -1; }
        .history-section { grid-column: 1 / -1; }
        .main-section { grid-column: 1 / -1; }

        table.dataTable { width: 100% !important; border-collapse: collapse !important; table-layout: fixed; margin-top: 15px !important; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        th:first-child, td:first-child { width: 40px; text-align: center; padding: 10px 0; }
        th { font-weight: 500; font-size: 0.8em; color: var(--font-color-muted); }
        td { font-size: 0.9em; }
        td.profit, .profit { color: var(--success-color); }
        td.loss, .loss { color: var(--danger-color); }
        tfoot td { font-weight: 600; border-top: 1px solid var(--border-color); }
        .clickable-asset { cursor: pointer; text-decoration: underline; }
        .clickable-asset:hover { color: var(--secondary-color); }
        .action-buttons button { padding: 4px 8px; font-size: 0.7em; margin-right: 5px; }
        .btn-edit { background: var(--warning-color); color: #000; border: none; }
        .btn-delete { background: var(--danger-color); color: white; border: none; }
        
        .chart-container { display: flex; gap: 20px; height: 250px; }
        .chart-wrapper { flex: 1; min-width: 0; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center; padding: 15px; box-sizing: border-box; }
        .modal-content { background-color: var(--card-color); margin: auto; padding: 25px; border: 1px solid var(--border-color); width: 90%; max-width: 600px; border-radius: 8px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-content.modal-lg { max-width: 900px; }
        .modal-body { overflow-y: auto; padding-right: 10px; }
        .modal-close { color: #aaa; align-self: flex-end; font-size: 24px; font-weight: bold; cursor: pointer; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 0; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.9em; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--primary-color); color: var(--font-color); box-sizing: border-box; font-size: 0.9em; font-family: 'Poppins', sans-serif; }
        textarea { resize: vertical; min-height: 60px; }
        
        .fab {
            position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; border-radius: 50%;
            background: linear-gradient(45deg, #00A8FF, #007BFF); color: white; display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); cursor: pointer; z-index: 100; transition: transform 0.2s;
        }
        .fab:hover { transform: scale(1.1); }
        
        .heatmap-container { display: flex; flex-direction: column; align-items: center; }
        .heatmap-nav { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; }
        .heatmap-nav button { padding: 5px 10px; font-size: 1em; width: auto; }
        .calendar-grid { width: 100%; }
        .calendar-grid th { text-align: center; font-size: 0.8em; }
        .calendar-grid td { text-align: center; height: 40px; border: 1px solid var(--border-color); background-color: var(--primary-color); position: relative; }
        
        .tools-buttons { display: flex; flex-direction: column; gap: 15px; }
        .tools-buttons .button, .tools-buttons label { width: 100%; }
        .import-instructions { font-size: 0.8em; color: var(--font-color-muted); margin-top: 20px; }
        .import-instructions ul { padding-left: 20px; margin-top: 5px; }
        .import-instructions li { margin-bottom: 5px; }

        .pl-detail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .pl-detail-card { background-color: var(--primary-color); padding: 15px; border-radius: 6px; cursor: pointer; transition: transform 0.2s; }
        .pl-detail-card:hover { transform: translateY(-3px); }
        .pl-detail-card h4 { margin: 0 0 10px 0; color: var(--secondary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .pl-detail-card p { margin: 0; font-size: 1.2em; font-weight: 600; }
        
        .table-responsive-wrapper { overflow-x: auto; }
        
        .dataTables_wrapper { width: 100%; color: var(--font-color-muted) !important;}
        .dataTables_length, .dataTables_filter, .dataTables_info, .dataTables_paginate { margin-bottom: 15px;}
        .dataTables_wrapper select, .dataTables_wrapper input { color: var(--font-color) !important; background-color: var(--primary-color) !important; border: 1px solid var(--border-color) !important; }
        .paginate_button { color: var(--font-color) !important; }
        .paginate_button.current, .paginate_button.current:hover { background: var(--secondary-color) !important; color: white !important; border: 1px solid var(--secondary-color) !important; }
        .paginate_button:hover { background: var(--primary-color) !important; border-color: var(--border-color) !important; }
        
        /* Forward Test Styles */
        .forward-test-form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; align-items: flex-end; margin-bottom: 15px; }
        .forward-test-form-grid .form-group { margin-bottom: 0; }
        .forward-test-form-grid button { grid-column: 3; justify-self: start; height: 42px; }
        .status-tp1, .status-tp2 { color: var(--success-color); font-weight: 600; }
        .status-sl { color: var(--danger-color); font-weight: 600; }
        .status-running { color: var(--warning-color); }


        @media (max-width: 1400px) { .grid-container, .page-container, .stat-grid { grid-template-columns: repeat(4, 1fr); } }
        
        @media (max-width: 900px) { 
            .grid-container, .page-container, .chart-container, .settings-container, .stat-grid, .tools-container { display: flex; flex-direction: column; } 
            .forward-test-form-grid { grid-template-columns: 1fr; }
            .forward-test-form-grid button { justify-self: stretch; }

            .responsive-table thead { display: none; }
            .responsive-table tr { display: block; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px; padding: 15px; }
            .responsive-table tfoot { display: none; }
            .responsive-table td {
                display: flex; justify-content: space-between; text-align: right; font-size: 0.9em; padding: 10px 5px;
                border-bottom: 1px solid var(--primary-color); white-space: normal; overflow: visible; text-overflow: clip;
            }
            .responsive-table td:last-child { border-bottom: none; }
            .responsive-table td::before {
                content: attr(data-label); font-weight: 600; color: var(--font-color-muted);
                text-align: left; margin-right: 15px;
            }
            .responsive-table td.action-buttons, .responsive-table td[data-label="Pilih"] { justify-content: center; }
            .responsive-table td.action-buttons::before, .responsive-table td[data-label="Pilih"]::before { display: none; }
            
            #portfolio-table, #forward-test-table { border-collapse: separate; border-spacing: 0 15px; margin-top: 0 !important; }
            #portfolio-table tbody tr, #forward-test-table tbody tr {
                padding: 0; border: none; background-color: var(--primary-color); border-radius: 8px;
            }
            #portfolio-table tbody td, #forward-test-table tbody td { background-color: var(--primary-color); padding: 15px; border: none; }
            .dataTables_wrapper .dataTables_paginate .paginate_button { padding: 0.4em 0.8em; }
            .dataTables_wrapper .dataTables_filter, .dataTables_wrapper .dataTables_info { text-align: left; width: 100%; }
            .dataTables_wrapper .dataTables_filter input { width: 95%; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="top-bar">
            <div class="app-title">Jurnal<span>Trading</span></div>
            <div class="hamburger-menu">
                <span class="bar"></span><span class="bar"></span><span class="bar"></span>
            </div>
        </div>
        <nav id="nav-sidebar" class="nav-sidebar">
            <a class="nav-tab active" data-tab="dashboard"><span>Dashboard</span></a>
            <a class="nav-tab" data-tab="forward-test"><span>Forward Testing</span></a>
            <a class="nav-tab" data-tab="tools"><span>Tools</span></a>
            <a class="nav-tab" data-tab="settings"><span>Settings</span></a>
            <a class="nav-tab" id="theme-toggle"><span id="theme-text">Mode Gelap</span></a>
        </nav>

        <main>
            <div id="dashboard-page" class="page-content active">
                <div class="grid-container">
                    <div class="stat-grid">
                        <div class="card stat-card" id="total-modal-card">
                            <h3>
                                Modal Aktif
                                <span id="unrealized-pl-percentage" style="font-size: 0.8em; margin-left: 8px; font-weight: 600;"></span>
                            </h3>
                            <div class="value-split">
                                <div>
                                    <h4 class="sub-heading">Disetor</h4>
                                    <div class="value" id="invested-capital-value">-</div>
                                </div>
                                <div>
                                    <h4 class="sub-heading">Saat Ini</h4>
                                    <div class="value" id="current-capital-value">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="card stat-card" id="rdn-cash-card"><h3>Kas di RDN</h3><div class="value">-</div></div>
                        <div class="card stat-card" id="total-pl-card"><h3>Total P/L</h3><div class="value">-</div></div>
                        <div class="card stat-card" id="win-rate-card"><h3>Win Rate</h3><div class="value">-</div></div>
                        <div class="card stat-card" id="profit-factor-card"><h3>Profit Factor</h3><div class="value">-</div></div>
                        <div class="card stat-card" id="avg-hold-card"><h3>Avg. Hold</h3><div class="value">-</div></div>
                        <div class="card stat-card" id="best-trade-card"><h3>Best Trade</h3><div class="value profit">-</div></div>
                        <div class="card stat-card" id="worst-trade-card"><h3>Trade Rugi</h3><div class="value loss">-</div></div>
                    </div>
                    
                    <section class="card portfolio-section">
                        <div class="card-header">
                            <h2>Portofolio Saat Ini</h2>
                            <button id="refresh-portfolio-btn" class="button btn-refresh"><i class="fas fa-sync"></i><i class="fas fa-spinner fa-spin"></i></button>
                        </div>
                        <div class="table-responsive-wrapper">
                             <table id="portfolio-table" class="responsive-table">
                                <thead>
                                    <tr>
                                        <th>Aset</th>
                                        <th>Sisa Lot</th>
                                        <th>Avg. Price</th>
                                        <th>Modal</th>
                                        <th>Harga Saat Ini</th>
                                        <th>+/- (Rp)</th>
                                        <th>+/- (%)</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                                <tfoot></tfoot>
                            </table>
                        </div>
                    </section>
                    <section class="card pl-section"><div class="card-header"><h2>Ringkasan Realisasi</h2><button id="view-pl-detail-btn" class="button btn-detail">Detail</button></div><div class="pl-summary"><div class="pl-item"><h4>Total Untung</h4><div class="pl-value profit" id="total-profit-value">-</div></div><div class="pl-item"><h4>Total Rugi</h4><div class="pl-value loss" id="total-loss-value">-</div></div></div></section>
                    <section class="card chart-section"><div class="card-header"><h2>Visualisasi Data</h2></div><div class="chart-container"><div class="chart-wrapper"><canvas id="equityChart"></canvas></div><div class="chart-wrapper"><canvas id="assetAllocationChart"></canvas></div></div></section>
                    <section class="card history-section">
                        <div class="card-header">
                            <h2>Riwayat Transaksi</h2>
                            <button id="delete-selected-btn" class="button btn-detail" style="display:none; background-color: var(--danger-color);">Hapus Terpilih</button>
                        </div>
                        <div class="table-responsive-wrapper">
                            <table id="history-table" class="display responsive-table">
                                <thead><tr><th><input type="checkbox" id="select-all-history"></th><th>Tanggal</th><th>Aset</th><th>Tipe</th><th>Lot/Unit</th><th>Harga</th><th>Nilai</th><th>Aksi</th></tr></thead><tbody></tbody>
                            </table>
                        </div>
                    </section>
                </div>
            </div>
            
            <div id="forward-test-page" class="page-content">
                <div class="page-container">
                    <section class="card main-section">
                        <div class="card-header">
                            <h2>Forward Testing Rekomendasi</h2>
                             <button id="refresh-forward-test-btn" class="button btn-refresh"><i class="fas fa-sync"></i><i class="fas fa-spinner fa-spin"></i></button>
                        </div>
                        <form id="forward-test-form">
                            <div class="forward-test-form-grid">
                                <div class="form-group"><label>Kode</label><input type="text" id="ft-kode" placeholder="BBCA" style="text-transform:uppercase" required></div>
                                <div class="form-group"><label>Tgl. Input</label><input type="date" id="ft-tanggal" required></div>
                                <div class="form-group"><label>Harga Input</label><input type="number" id="ft-harga" placeholder="9000" required></div>
                                <div class="form-group"><label>TP 1</label><input type="number" id="ft-tp1" placeholder="9500" required></div>
                                <div class="form-group"><label>TP 2</label><input type="number" id="ft-tp2" placeholder="10000"></div>
                                <div class="form-group"><label>Stop Loss</label><input type="number" id="ft-sl" placeholder="8800" required></div>
                            </div>
                             <button type="submit" class="button">Tambah Rekomendasi</button>
                        </form>
                        <div class="table-responsive-wrapper" style="margin-top: 20px;">
                             <table id="forward-test-table" class="responsive-table">
                                <thead>
                                    <tr>
                                        <th>Kode</th>
                                        <th>Tgl. Input</th>
                                        <th>Harga Input</th>
                                        <th>TP 1</th>
                                        <th>TP 2</th>
                                        <th>SL</th>
                                        <th>Harga Sekarang</th>
                                        <th>+/- (%)</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </section>
                </div>
            </div>

            <div id="tools-page" class="page-content">
                <div class="tools-container">
                    <div class="card">
                        <div class="card-header"><h2>Kalender Performa (Heatmap)</h2></div>
                        <div class="heatmap-container">
                            <div class="heatmap-nav"><button id="prev-month-btn" class="button btn-detail">&lt;</button><h3 id="month-year-label"></h3><button id="next-month-btn" class="button btn-detail">&gt;</button></div>
                            <table id="calendar-heatmap" class="calendar-grid"></table>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h2>Impor / Ekspor Data</h2></div>
                        <div class="tools-buttons">
                            <button id="download-template-btn" class="button secondary">Unduh Template CSV</button>
                            <label for="import-csv-input" class="button secondary">Impor dari CSV</label>
                            <input type="file" id="import-csv-input" accept=".csv" style="display:none;">
                            <button id="export-csv-btn" class="button secondary">Ekspor Semua Transaksi</button>
                        </div>
                        <div class="import-instructions"><strong>Format CSV (pemisah titik koma ';') harus memiliki header:</strong><ul><li><b>tanggal:</b>YYYY-MM-DD</li><li><b>tipe:</b> Beli, Jual, atau Dividen</li><li><b>aset:</b> Kode saham (misal: BBCA)</li><li><b>lot:</b> Jumlah lot (wajib untuk Beli/Jual)</li><li><b>harga:</b> Harga per lembar (wajib untuk Beli/Jual)</li><li><b>biaya:</b> Biaya transaksi (wajib untuk Beli/Jual)</li><li><b>jumlah:</b> Jumlah dividen (hanya untuk tipe Dividen)</li></ul></div>
                    </div>
                </div>
            </div>
            <div id="settings-page" class="page-content">
                <div class="settings-container">
                    <div class="card"><h2>Modal Awal</h2><form id="initial-capital-form"><div class="form-group"><label for="initial-capital">Masukkan Jumlah Modal Awal</label><input type="number" id="initial-capital" placeholder="10000000" required></div><button type="submit">Simpan Modal Awal</button></form></div>
                    <div class="card"><h2>Arus Kas RDN</h2><form id="cash-flow-form"><div class="form-group"><label for="cash-flow-type">Tipe</label><select id="cash-flow-type" required><option value="Setor">Setor Dana</option><option value="Tarik">Tarik Dana</option></select></div><div class="form-group"><label for="cash-flow-amount">Jumlah</label><input type="number" id="cash-flow-amount" placeholder="5000000" required></div><div class="form-group"><label for="cash-flow-date">Tanggal</label><input type="date" id="cash-flow-date" required></div><button type="submit">Catat Arus Kas</button></form></div>
                </div>
            </div>
        </main>
        <div id="fab-add-transaction" class="fab">+</div>
    </div>
    
    <div id="transaction-modal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2 id="modal-title"></h2><form id="transaction-form"><input type="hidden" id="edit-id"><div class="form-grid"><div class="form-group"><label for="tanggal">Tanggal</label><input type="date" id="tanggal" required></div><div class="form-group"><label for="tipe">Tipe</label><select id="tipe" required><option value="Beli">Beli</option><option value="Jual">Jual</option><option value="Dividen">Dividen</option></select></div></div><div class="form-group full-width" id="group-aset"><label for="aset">Kode Aset</label><input type="text" id="aset" placeholder="Contoh: BBCA" style="text-transform:uppercase" required></div><div id="trade-fields"><div class="form-grid"><div class="form-group"><label for="lot">Jumlah Lot/Unit</label><input type="number" step="any" id="lot" placeholder="10" required></div><div class="form-group"><label for="harga">Harga /Lembar</label><input type="number" step="any" id="harga" placeholder="9000" required></div></div><div class="form-group full-width" id="group-biaya"><label for="biaya">Biaya Transaksi (Default 0)</label><input type="number" step="any" id="biaya" placeholder="0"></div></div><div class="form-group full-width" id="group-dividen" style="display:none;"><label for="dividen-amount">Jumlah Dividen (Net)</label><input type="number" id="dividen-amount" placeholder="100000"></div><div class="form-group full-width"><label for="keterangan">Keterangan</label><textarea id="keterangan" rows="2"></textarea></div><button type="submit" id="submit-button"></button></form></div></div>
    <div id="pl-detail-modal" class="modal"><div class="modal-content modal-lg"><span class="modal-close">&times;</span><h2>Detail Realisasi Profit/Loss</h2><div id="pl-detail-grid" class="modal-body pl-detail-grid"></div></div></div>
    <div id="recap-modal" class="modal"><div class="modal-content modal-lg"><span class="modal-close">&times;</span><h2 id="recap-asset-code"></h2><div class="modal-body"><table id="recap-table"><thead><tr><th>Tanggal</th><th>Tipe</th><th>Lot/Unit</th><th>Harga</th><th>Nilai</th></tr></thead><tbody></tbody><tfoot></tfoot></table></div></div></div>
    <div id="import-preview-modal" class="modal"><div class="modal-content modal-lg"><span class="modal-close">&times;</span><h2>Pratinjau Impor CSV</h2><p>Pastikan data di bawah ini benar sebelum melanjutkan.</p><div class="modal-body"><table id="import-preview-table"></table></div><div style="display:flex; gap:10px; margin-top:20px;"><button id="confirm-import-btn" class="button">Impor Data Ini</button><button id="cancel-import-btn" class="button secondary">Batal</button></div></div></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Firebase setup
            const firebaseConfig = { apiKey: "AIzaSyBKlHGg5HYyUQPRT1BzVNix_tWGQ_jgq0k", authDomain: "saham-tracker.firebaseapp.com", projectId: "saham-tracker", storageBucket: "saham-tracker.appspot.com", messagingSenderId: "317401870829", appId: "1:317401870829:web:eb5fe32a87a78cc8c637e4" };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const EOD_API_KEY = '686231880e9952.63982103';

            // State variables
            let allTransactions = [], initialCapital = 0, allCashflows = [], marketData = {}, forwardTestData = [], lastAnalysisResult = null, historyDataTable = null, csvPreviewData = [];
            
            // Formatters
            const formatCurrency = (number, withRp = true) => {
                if (isNaN(number) || number === null) return '-';
                const options = { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 };
                if (!withRp) {
                    return new Intl.NumberFormat('id-ID', { minimumFractionDigits: 0 }).format(number);
                }
                return new Intl.NumberFormat('id-ID', options).format(number);
            }

            // UI Elements
            const ui = {
                transactionModal: document.getElementById('transaction-modal'), recapModal: document.getElementById('recap-modal'), plDetailModal: document.getElementById('pl-detail-modal'), importPreviewModal: document.getElementById('import-preview-modal'),
                navSidebar: document.getElementById('nav-sidebar'), hamburgerMenu: document.querySelector('.hamburger-menu'),
                navTabs: document.querySelectorAll('.nav-tab'), pages: document.querySelectorAll('.page-content'),
                fab: document.getElementById('fab-add-transaction'), viewPlDetailBtn: document.getElementById('view-pl-detail-btn'),
                plDetailGrid: document.getElementById('pl-detail-grid'),
                historyTable: { table: document.getElementById('history-table') },
                recapTable: { body: document.querySelector("#recap-table tbody"), foot: document.querySelector("#recap-table tfoot") },
                recapAssetCode: document.getElementById('recap-asset-code'),
                transactionForm: document.getElementById('transaction-form'), 
                submitButton: document.getElementById('submit-button'), 
                modalTitle: document.getElementById('modal-title'),
                transactionTypeSelect: document.getElementById('tipe'),
                lotInput: document.getElementById('lot'),
                hargaInput: document.getElementById('harga'),
                dividenAmountInput: document.getElementById('dividen-amount'),
                statCards: { 
                    investedCapital: document.getElementById('invested-capital-value'),
                    currentCapital: document.getElementById('current-capital-value'),
                    unrealizedPLPercentage: document.getElementById('unrealized-pl-percentage'),
                    rdn: document.getElementById('rdn-cash-card')?.querySelector('.value'), 
                    pl: document.getElementById('total-pl-card')?.querySelector('.value'), 
                    winRate: document.getElementById('win-rate-card')?.querySelector('.value'), 
                    profitFactor: document.getElementById('profit-factor-card')?.querySelector('.value'),
                    avgHold: document.getElementById('avg-hold-card')?.querySelector('.value'), 
                    bestTrade: document.getElementById('best-trade-card'), 
                    worstTrade: document.getElementById('worst-trade-card'),
                },
                plSummary: { profit: document.getElementById('total-profit-value'), loss: document.getElementById('total-loss-value') },
                themeToggle: document.getElementById('theme-toggle'), themeText: document.getElementById('theme-text'),
                initialCapitalForm: document.getElementById('initial-capital-form'),
                cashFlowForm: document.getElementById('cash-flow-form'),
                heatmap: { container: document.getElementById('calendar-heatmap'), navLabel: document.getElementById('month-year-label'), prevBtn: document.getElementById('prev-month-btn'), nextBtn: document.getElementById('next-month-btn')},
                exportBtn: document.getElementById('export-csv-btn'), importInput: document.getElementById('import-csv-input'), downloadTemplateBtn: document.getElementById('download-template-btn'),
                importPreview: { table: document.getElementById('import-preview-table'), confirmBtn: document.getElementById('confirm-import-btn'), cancelBtn: document.getElementById('cancel-import-btn') },
                deleteSelectedBtn: document.getElementById('delete-selected-btn'),
                portfolioTable: { body: document.querySelector("#portfolio-table tbody"), foot: document.querySelector("#portfolio-table tfoot") },
                // Forward Test UI
                refreshPortfolioBtn: document.getElementById('refresh-portfolio-btn'), // Added for consistency
                refreshForwardTestBtn: document.getElementById('refresh-forward-test-btn'),
                forwardTestForm: document.getElementById('forward-test-form'),
                forwardTestTableBody: document.querySelector('#forward-test-table tbody'),
            };
            
            let currentHeatmapDate = new Date();
            let equityChart, allocationChart;

            // --- EVENT LISTENERS ---
            function setupEventListeners() {
                ui.hamburgerMenu.addEventListener('click', () => ui.navSidebar.classList.toggle('active'));
                ui.navSidebar.addEventListener('click', (e) => {
                    const tab = e.target.closest('.nav-tab');
                    if (!tab) return;
                    if (tab.dataset.tab) switchTab(tab.dataset.tab);
                    else if (tab.id === 'theme-toggle') { let newTheme = document.body.classList.contains('light-mode') ? 'dark-mode' : 'light-mode'; localStorage.setItem('theme', newTheme); updateThemeUI(newTheme); }
                });

                if(ui.fab) ui.fab.onclick = () => openModal();
                document.querySelectorAll('.modal-close').forEach(el => el.onclick = () => el.closest('.modal').style.display = 'none');
                window.onclick = (e) => { if (e.target.classList.contains('modal')) e.target.style.display = 'none'; };
                
                if(ui.refreshPortfolioBtn) ui.refreshPortfolioBtn.onclick = () => {
                    if (lastAnalysisResult && lastAnalysisResult.portfolioData) {
                         refreshMarketData(lastAnalysisResult.portfolioData.map(p => p.aset), ui.refreshPortfolioBtn);
                    }
                }
                if(ui.refreshForwardTestBtn) ui.refreshForwardTestBtn.onclick = () => {
                    const assetsToRefresh = [...new Set([...forwardTestData.map(item => item.kode)])];
                    refreshMarketData(assetsToRefresh, ui.refreshForwardTestBtn);
                };
                if(ui.forwardTestForm) ui.forwardTestForm.addEventListener('submit', handleForwardTestSubmit);
                if(ui.transactionForm) ui.transactionForm.addEventListener('submit', handleTransactionSubmit);
                if(ui.transactionTypeSelect) ui.transactionTypeSelect.addEventListener('change', (e) => toggleTransactionFields(e.target.value));

                // Tools & Settings Listeners
                if(ui.heatmap.prevBtn) ui.heatmap.prevBtn.onclick = () => { currentHeatmapDate.setMonth(currentHeatmapDate.getMonth() - 1); renderHeatmap(allTransactions); };
                if(ui.heatmap.nextBtn) ui.heatmap.nextBtn.onclick = () => { currentHeatmapDate.setMonth(currentHeatmapDate.getMonth() + 1); renderHeatmap(allTransactions); };
                if(ui.exportBtn) ui.exportBtn.onclick = () => exportToCSV(allTransactions);
                if(ui.downloadTemplateBtn) ui.downloadTemplateBtn.onclick = downloadCSVTemplate;
                if(ui.importInput) ui.importInput.onchange = (e) => importFromCSV(e.target.files[0]);
                if(ui.importPreview.confirmBtn) ui.importPreview.confirmBtn.onclick = confirmImport;
                if(ui.importPreview.cancelBtn) ui.importPreview.cancelBtn.onclick = () => closeModal(ui.importPreviewModal);
                if (ui.deleteSelectedBtn) ui.deleteSelectedBtn.onclick = handleBulkDelete;
                if(ui.historyTable.table) {
                    ui.historyTable.table.addEventListener('change', (e) => {
                        if(e.target.matches('.history-checkbox, #select-all-history')) {
                            const isSelectAll = e.target.id === 'select-all-history';
                            ui.historyTable.table.querySelectorAll('.history-checkbox').forEach(cb => cb.checked = isSelectAll ? e.target.checked : cb.checked);
                            const checkboxes = ui.historyTable.table.querySelectorAll('.history-checkbox:checked');
                            if(ui.deleteSelectedBtn) ui.deleteSelectedBtn.style.display = checkboxes.length > 0 ? 'inline-flex' : 'none';
                        }
                    });
                }
                if(ui.initialCapitalForm) ui.initialCapitalForm.addEventListener('submit', (e) => { e.preventDefault(); const capital = parseFloat(document.getElementById('initial-capital').value); db.collection('settings').doc('capital').set({ initial: capital }); });
                if(ui.cashFlowForm) ui.cashFlowForm.addEventListener('submit', (e) => { e.preventDefault(); db.collection('cashflow').add({ tipe: document.getElementById('cash-flow-type').value, jumlah: parseFloat(document.getElementById('cash-flow-amount').value), tanggal: document.getElementById('cash-flow-date').value }); ui.cashFlowForm.reset(); });
            }

            // --- DATA INITIALIZATION & SYNC ---
            function initializeAndSyncData() {
                db.collection('transactions').orderBy('tanggal', 'asc').onSnapshot(snapshot => {
                    allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    processAndRenderAll();
                });

                Promise.all([
                    db.collection('settings').doc('capital').get(),
                    db.collection('cashflow').orderBy('tanggal', 'asc').get(),
                    db.collection('marketData').get()
                ]).then(([capitalSnapshot, cashflowSnapshot, marketDataSnapshot]) => {
                    initialCapital = capitalSnapshot.exists ? capitalSnapshot.data().initial : 0;
                    allCashflows = cashflowSnapshot.docs.map(doc => doc.data());
                    marketDataSnapshot.forEach(doc => { marketData[doc.id] = doc.data(); });
                    processAndRenderAll();
                });
                
                db.collection('marketData').onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => { marketData[change.doc.id] = change.doc.data(); });
                    if (lastAnalysisResult) {
                        processAndRenderAll();
                    }
                });

                db.collection('forward_testing').orderBy('tanggal', 'desc').onSnapshot(snapshot => {
                    forwardTestData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderForwardTestingTable();
                });
            }
            
            // --- CORE LOGIC & ANALYSIS ---
            function processAndRenderAll() {
                if (!allTransactions) return;
                lastAnalysisResult = analyzeData(allTransactions, initialCapital, allCashflows);
                renderStatCards(lastAnalysisResult);
                renderPortfolioTable(lastAnalysisResult.portfolioData);
                renderPLSummary(lastAnalysisResult.totalProfit, lastAnalysisResult.totalLoss);
                if(ui.viewPlDetailBtn) ui.viewPlDetailBtn.onclick = () => renderPLDetailModal(lastAnalysisResult.plData);
                renderHistoryTable(allTransactions);
                renderEquityChart(lastAnalysisResult.equityData);
                renderAllocationChart(lastAnalysisResult.portfolioData);
                renderHeatmap(allTransactions);
                renderForwardTestingTable();
            }
            
            function analyzeData(transactions, initialCapital, cashflows) {
                const groupedByAset = transactions.reduce((acc, t) => { (acc[t.aset] = acc[t.aset] || []).push(t); return acc; }, {});
                let portfolioData = [], plData = [], totalPortfolioModal = 0, currentPortfolioValue = 0, totalRealizedPL = 0, winningTrades = 0, losingTrades = 0, totalProfit = 0, totalLoss = 0, bestTrade = 0, worstTrade = 0;
                let totalHoldingDays = 0, totalLotsSold = 0, cashBalance = initialCapital, tradeDetails = [];

                cashflows.forEach(cf => { cashBalance += cf.tipe === 'Setor' ? cf.jumlah : -cf.jumlah; });
                transactions.forEach(tx => {
                    if (tx.tipe === 'Beli') cashBalance -= (tx.lot * 100 * tx.harga + (tx.biaya || 0));
                    else if (tx.tipe === 'Jual') cashBalance += (tx.lot * 100 * tx.harga - (tx.biaya || 0));
                    else if (tx.tipe === 'Dividen') cashBalance += tx.jumlah;
                });

                for (const aset in groupedByAset) {
                    const txs = [...groupedByAset[aset]].sort((a,b) => new Date(a.tanggal) - new Date(b.tanggal));
                    let realizedPLForAsset = 0; let buys = [];
                    txs.forEach(tx => {
                        if (tx.tipe === 'Beli') {
                            buys.push({ lot: tx.lot, cost: tx.lot * 100 * tx.harga + (tx.biaya || 0), date: new Date(tx.tanggal) });
                        } else if (tx.tipe === 'Jual') {
                            let lotToSell = tx.lot, revenue = tx.lot * 100 * tx.harga - (tx.biaya || 0), costOfSoldLots = 0;
                            const sellDate = new Date(tx.tanggal);
                            while (lotToSell > 0 && buys.length > 0) {
                                const firstBuy = buys[0], lotFromThisBuy = Math.min(lotToSell, firstBuy.lot), costPerLot = firstBuy.cost / firstBuy.lot;
                                const holdingDays = (sellDate - firstBuy.date) / (1000 * 3600 * 24);
                                costOfSoldLots += lotFromThisBuy * costPerLot;
                                totalHoldingDays += lotFromThisBuy * holdingDays;
                                firstBuy.lot -= lotFromThisBuy; firstBuy.cost -= lotFromThisBuy * costPerLot;
                                lotToSell -= lotFromThisBuy;
                                if (firstBuy.lot < 1e-7) buys.shift();
                            }
                            totalLotsSold += tx.lot;
                            const tradePL = revenue - costOfSoldLots;
                            tradeDetails.push({ pl: tradePL });
                            realizedPLForAsset += tradePL;
                            if(tradePL > 0) { winningTrades++; totalProfit += tradePL; if(tradePL > bestTrade) bestTrade = tradePL; } 
                            else { losingTrades++; totalLoss += tradePL; if(tradePL < worstTrade) worstTrade = tradePL; }
                        } else if (tx.tipe === 'Dividen') { realizedPLForAsset += tx.jumlah; totalProfit += tx.jumlah; }
                    });
                    let sisaLot = 0, modalDisetor = 0;
                    buys.forEach(buy => { sisaLot += buy.lot; modalDisetor += buy.cost; });
                    if (sisaLot > 1e-7) {
                        const avgPriceBeli = modalDisetor / (sisaLot * 100);
                        portfolioData.push({ aset, sisaLot: parseFloat(sisaLot.toFixed(2)), avgPriceBeli, totalModal: modalDisetor });
                        totalPortfolioModal += modalDisetor;
                        const currentPrice = marketData[aset]?.close || avgPriceBeli;
                        currentPortfolioValue += sisaLot * 100 * currentPrice;
                    }
                    if (realizedPLForAsset !== 0) plData.push({ aset, plRealisasi: realizedPLForAsset });
                    totalRealizedPL += realizedPLForAsset;
                }
                
                let cumulativePL = 0; const equityData = [];
                [...allTransactions].sort((a,b) => new Date(a.tanggal) - new Date(b.tanggal)).forEach(tx => {
                    if (tx.tipe !== 'Beli') { cumulativePL += getRealizedPLForTx(tx, allTransactions); equityData.push({ date: tx.tanggal, pnl: cumulativePL }); }
                });
                
                const winRate = (winningTrades + losingTrades > 0) ? (winningTrades / (winningTrades + losingTrades)) * 100 : 0;
                const profitFactor = totalLoss !== 0 ? Math.abs(totalProfit / totalLoss) : Infinity;
                const avgHold = totalLotsSold > 0 ? totalHoldingDays / totalLotsSold : 0;
                const unrealizedPL = currentPortfolioValue - totalPortfolioModal;
                const unrealizedPLPercentage = totalPortfolioModal > 0 ? (unrealizedPL / totalPortfolioModal) * 100 : 0;
                
                return { portfolioData, plData, equityData, totalPortfolioModal, currentPortfolioValue, unrealizedPLPercentage, rdnCash: cashBalance, totalRealizedPL, winRate, profitFactor, totalProfit, totalLoss, bestTrade, worstTrade, avgHold, tradeDetails };
            }

            // --- RENDER FUNCTIONS ---
            function renderStatCards(analysis) {
                for (const card in ui.statCards) { if(!ui.statCards[card]) continue; }

                if(ui.statCards.investedCapital) ui.statCards.investedCapital.textContent = formatCurrency(analysis.totalPortfolioModal);
                if(ui.statCards.currentCapital) {
                    ui.statCards.currentCapital.textContent = formatCurrency(analysis.currentPortfolioValue);
                    ui.statCards.currentCapital.className = `value ${analysis.currentPortfolioValue >= analysis.totalPortfolioModal ? 'profit' : 'loss'}`;
                }
                if(ui.statCards.unrealizedPLPercentage) {
                    const percent = analysis.unrealizedPLPercentage;
                    if (analysis.totalPortfolioModal > 0) {
                        ui.statCards.unrealizedPLPercentage.textContent = `(${percent >= 0 ? '+' : ''}${percent.toFixed(2)}%)`;
                        ui.statCards.unrealizedPLPercentage.className = percent >= 0 ? 'profit' : 'loss';
                    } else {
                        ui.statCards.unrealizedPLPercentage.textContent = '';
                    }
                }
                
                ui.statCards.rdn.textContent = formatCurrency(analysis.rdnCash); 
                ui.statCards.pl.textContent = formatCurrency(analysis.totalRealizedPL); 
                ui.statCards.pl.className = `value ${analysis.totalRealizedPL >= 0 ? 'profit' : 'loss'}`;
                ui.statCards.winRate.textContent = `${analysis.winRate.toFixed(1)}%`; 
                ui.statCards.profitFactor.textContent = isFinite(analysis.profitFactor) ? analysis.profitFactor.toFixed(2) : '∞';
                const bestTradeValueEl = ui.statCards.bestTrade.querySelector('.value');
                bestTradeValueEl.textContent = formatCurrency(analysis.bestTrade);
                const worstTradeValueEl = ui.statCards.worstTrade.querySelector('.value');
                worstTradeValueEl.textContent = formatCurrency(analysis.worstTrade);
                ui.statCards.avgHold.textContent = `${analysis.avgHold.toFixed(1)} Hari`;
            }

            function renderPortfolioTable(data) {
                if (!ui.portfolioTable.body) return;
                ui.portfolioTable.body.innerHTML = ''; 
                data.forEach(item => {
                    const currentPriceData = marketData[item.aset] || {};
                    const price = currentPriceData.close || item.avgPriceBeli; // Use avg price if no market data
                    const currentValue = item.sisaLot * 100 * price;
                    const pl = currentValue - item.totalModal;
                    const plPercent = item.totalModal > 0 ? (pl / item.totalModal) * 100 : 0;
                    const changeClass = pl >= 0 ? 'profit' : 'loss';

                    ui.portfolioTable.body.innerHTML += `
                    <tr>
                        <td data-label="Aset">${item.aset}</td>
                        <td data-label="Sisa Lot">${item.sisaLot.toLocaleString('id-ID')}</td>
                        <td data-label="Avg. Price">${formatCurrency(item.avgPriceBeli, false)}</td>
                        <td data-label="Modal">${formatCurrency(item.totalModal, false)}</td>
                        <td data-label="Harga Saat Ini">${price > 0 ? formatCurrency(price, false) : '-'}</td>
                        <td data-label="+/- (Rp)" class="${changeClass}">${price > 0 ? formatCurrency(pl, false) : '-'}</td>
                        <td data-label="+/- (%)" class="${changeClass}">${price > 0 ? plPercent.toFixed(2) + '%' : '-'}</td>
                    </tr>`;
                });
            }
            
            function renderForwardTestingTable() {
                if (!ui.forwardTestTableBody) return;
                ui.forwardTestTableBody.innerHTML = '';
                forwardTestData.forEach(item => {
                    const currentPriceData = marketData[item.kode] || {};
                    const currentPrice = currentPriceData.close || 0;

                    let status = 'Running';
                    let statusClass = 'status-running';

                    if (currentPrice > 0) {
                        if (item.tp2 && currentPrice >= item.tp2) { status = 'TP 2 Hit'; statusClass = 'status-tp2'; } 
                        else if (item.tp1 && currentPrice >= item.tp1) { status = 'TP 1 Hit'; statusClass = 'status-tp1'; } 
                        else if (item.sl && currentPrice <= item.sl) { status = 'SL Hit'; statusClass = 'status-sl'; }
                    }

                    const percentageChange = currentPrice > 0 && item.harga > 0 ? ((currentPrice - item.harga) / item.harga) * 100 : 0;
                    const percentageChangeClass = percentageChange >= 0 ? 'profit' : 'loss';

                    ui.forwardTestTableBody.innerHTML += `
                        <tr>
                            <td data-label="Kode">${item.kode}</td>
                            <td data-label="Tgl. Input">${item.tanggal}</td>
                            <td data-label="Harga Input">${formatCurrency(item.harga, false)}</td>
                            <td data-label="TP 1">${formatCurrency(item.tp1, false)}</td>
                            <td data-label="TP 2">${item.tp2 ? formatCurrency(item.tp2, false) : '-'}</td>
                            <td data-label="SL">${formatCurrency(item.sl, false)}</td>
                            <td data-label="Harga Sekarang">${currentPrice > 0 ? formatCurrency(currentPrice, false) : '-'}</td>
                            <td data-label="+/- (%)" class="${percentageChangeClass}">${currentPrice > 0 ? percentageChange.toFixed(2) + '%' : '-'}</td>
                            <td data-label="Status"><span class="${statusClass}">${status}</span></td>
                            <td data-label="Aksi" class="action-buttons">
                                <button class="btn-delete" onclick="handleDeleteForwardTest('${item.id}')">Hapus</button>
                            </td>
                        </tr>
                    `;
                });
            }


            // --- API & DB INTERACTIONS ---
            async function refreshMarketData(assetList, button) {
                if (!assetList || assetList.length === 0) return;
                
                button.classList.add('loading');
                const uniqueAssets = [...new Set(assetList)];
                const promises = uniqueAssets.map(asset => {
                    if (!asset) return Promise.resolve(); // Skip if asset is undefined/null
                    const url = `https://eodhistoricaldata.com/api/real-time/${asset}.JK?api_token=${EOD_API_KEY}&fmt=json`;
                    return fetch(url)
                        .then(res => res.json())
                        .then(data => {
                            if (data && data.code && data.close !== undefined) {
                                // Update local state immediately for faster UI response
                                marketData[data.code.replace('.JK', '')] = {
                                    close: data.close,
                                    change: data.change,
                                    change_p: data.change_p,
                                };
                                // Update Firestore in the background
                                return db.collection('marketData').doc(data.code.replace('.JK', '')).set({
                                    close: data.close,
                                    change: data.change,
                                    change_p: data.change_p,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                }, { merge: true });
                            } else {
                                console.warn(`No valid data for ${asset}`, data);
                            }
                        }).catch(err => console.error(`Failed to fetch ${asset}:`, err));
                });

                await Promise.all(promises);
                processAndRenderAll(); // Force re-render immediately after all fetches complete
                button.classList.remove('loading');
            }
            
            function handleForwardTestSubmit(e) {
                e.preventDefault();
                const data = {
                    kode: document.getElementById('ft-kode').value.toUpperCase(),
                    tanggal: document.getElementById('ft-tanggal').value,
                    harga: parseFloat(document.getElementById('ft-harga').value),
                    tp1: parseFloat(document.getElementById('ft-tp1').value),
                    tp2: parseFloat(document.getElementById('ft-tp2').value) || null,
                    sl: parseFloat(document.getElementById('ft-sl').value),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (data.kode && data.tanggal && data.harga && data.tp1 && data.sl) {
                    db.collection('forward_testing').add(data)
                        .then(() => {
                            ui.forwardTestForm.reset();
                            document.getElementById('ft-tanggal').value = new Date().toISOString().split('T')[0];
                        })
                        .catch(err => console.error("Error adding forward test: ", err));
                } else {
                    alert('Harap isi semua field yang wajib diisi.');
                }
            }

            window.handleDeleteForwardTest = (id) => {
                if(confirm(`Yakin ingin menghapus data forward test ini?`)) {
                    db.collection('forward_testing').doc(id).delete();
                }
            };
            
            // --- UI & UTILITY FUNCTIONS (Added back) ---
            function switchTab(tabId) {
                ui.pages.forEach(p => p.classList.remove('active'));
                ui.navTabs.forEach(t => t.classList.remove('active'));
                document.getElementById(`${tabId}-page`)?.classList.add('active');
                document.querySelector(`.nav-tab[data-tab="${tabId}"]`)?.classList.add('active');
                ui.navSidebar.classList.remove('active');
            }

            function updateThemeUI(theme) {
                document.body.className = theme === 'light-mode' ? 'light-mode' : '';
                if (ui.themeText) ui.themeText.textContent = theme === 'light-mode' ? 'Mode Terang' : 'Mode Gelap';
                if (lastAnalysisResult) {
                    renderEquityChart(lastAnalysisResult.equityData);
                    renderAllocationChart(lastAnalysisResult.portfolioData);
                }
            }

            function getRealizedPLForTx(currentTx, allTxs) {
                 if (currentTx.tipe === 'Dividen') return currentTx.jumlah; if (currentTx.tipe === 'Beli') return 0;
                const assetHistory = allTxs.filter(tx => tx.aset === currentTx.aset && new Date(tx.tanggal) <= new Date(currentTx.tanggal));
                const buys = []; let realizedPL = 0;
                assetHistory.forEach(tx => {
                    if (tx.tipe === 'Beli') buys.push({ lot: tx.lot, cost: tx.lot * 100 * tx.harga + (tx.biaya || 0) });
                    else if (tx.id === currentTx.id) {
                        let lotToSell = tx.lot, revenue = tx.lot * 100 * tx.harga - (tx.biaya || 0), costOfSoldLots = 0;
                        while(lotToSell > 0 && buys.length > 0) {
                            const firstBuy = buys[0], lotFromThisBuy = Math.min(lotToSell, firstBuy.lot), costPerLot = firstBuy.cost / firstBuy.lot;
                            costOfSoldLots += lotFromThisBuy * costPerLot;
                            firstBuy.lot -= lotFromThisBuy; firstBuy.cost -= lotFromThisBuy * costPerLot;
                            lotToSell -= lotFromThisBuy;
                            if (firstBuy.lot < 1e-7) buys.shift();
                        }
                        realizedPL = revenue - costOfSoldLots;
                    }
                });
                return realizedPL;
            }

            function renderPLSummary(profit, loss) {
                if(!ui.plSummary.profit || !ui.plSummary.loss) return;
                ui.plSummary.profit.textContent = formatCurrency(profit);
                ui.plSummary.loss.textContent = formatCurrency(Math.abs(loss));
            }

            function renderHistoryTable(transactions) {
                if(!ui.historyTable.table) return;
                if(historyDataTable) historyDataTable.destroy();
                const tableBody = ui.historyTable.table.querySelector('tbody');
                tableBody.innerHTML = '';
                transactions.forEach(tx => {
                    tableBody.innerHTML += `<tr>
                        <td data-label="Pilih"><input type="checkbox" class="history-checkbox" data-id="${tx.id}"></td>
                        <td data-label="Tanggal">${tx.tanggal}</td>
                        <td data-label="Aset">${tx.aset}</td>
                        <td data-label="Tipe">${tx.tipe}</td>
                        <td data-label="Lot/Unit">${tx.tipe === 'Dividen' ? '-' : (tx.lot || '').toLocaleString('id-ID')}</td>
                        <td data-label="Harga">${tx.tipe === 'Dividen' ? formatCurrency(tx.jumlah) : formatCurrency(tx.harga)}</td>
                        <td data-label="Nilai">${tx.tipe === 'Dividen' ? '-' : formatCurrency(tx.lot * 100 * tx.harga)}</td>
                        <td data-label="Aksi" class="action-buttons"><button class="btn-edit" onclick="handleEdit('${tx.id}')">E</button><button class="btn-delete" onclick="handleDelete('${tx.id}')">H</button></td>
                    </tr>`;
                });
                historyDataTable = $(ui.historyTable.table).DataTable({ "order": [[ 1, "desc" ]], "pageLength": 5, "searching": true, "lengthChange": false, "columnDefs": [{ "orderable": false, "targets": 0 }], "language": { "search": "", "searchPlaceholder": "Cari..." }, "responsive": false });
            }

             function renderEquityChart(chartData) {
                const ctx = document.getElementById('equityChart')?.getContext('2d'); if(!ctx) return; if(equityChart) equityChart.destroy();
                equityChart = new Chart(ctx, { type: 'line', data: { datasets: [{ label: 'P/L Kumulatif', data: chartData.map(d => ({x: new Date(d.date), y: d.pnl})), borderColor: '#00A8FF', backgroundColor: 'rgba(0, 168, 255, 0.1)', fill: true, tension: 0.1, pointRadius: 2 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' }, ticks: { color: getComputedStyle(document.body).getPropertyValue('--font-color-muted'), maxRotation: 0, autoSkip: true, maxTicksLimit: 7 }, grid: { color: getComputedStyle(document.body).getPropertyValue('--border-color') } }, y: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--font-color-muted'), callback: (value) => formatCurrency(value).replace('Rp','').trim() }, grid: { color: getComputedStyle(document.body).getPropertyValue('--border-color') } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (context) => `P/L: ${formatCurrency(context.parsed.y)}` } } } } });
            }

            function renderAllocationChart(portfolioData) {
                const ctx = document.getElementById('assetAllocationChart')?.getContext('2d'); if(!ctx) return; if(allocationChart) allocationChart.destroy();
                allocationChart = new Chart(ctx, { type: 'doughnut', data: { labels: portfolioData.map(p => p.aset), datasets: [{ label: 'Alokasi Modal', data: portfolioData.map(p => p.totalModal), backgroundColor: ['#00A8FF', '#007BFF', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6610f2'], borderColor: getComputedStyle(document.body).getPropertyValue('--card-color'), borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: getComputedStyle(document.body).getPropertyValue('--font-color'), boxWidth: 10, padding: 10 } } } } });
            }

            function renderPLDetailModal(data) {
                if(!ui.plDetailGrid) return;
                ui.plDetailGrid.innerHTML = '';
                if(!data || data.length === 0) { ui.plDetailGrid.innerHTML = '<p>Belum ada profit/loss yang direalisasikan.</p>'; }
                else {
                    data.sort((a,b) => b.plRealisasi - a.plRealisasi).forEach(item => {
                        const plClass = item.plRealisasi >= 0 ? 'profit' : 'loss';
                        ui.plDetailGrid.innerHTML += `<div class="pl-detail-card clickable-asset" onclick="handleRecap('${item.aset}')"><h4>${item.aset}</h4><p class="${plClass}">${formatCurrency(item.plRealisasi)}</p></div>`;
                    });
                }
                ui.plDetailModal.style.display = 'flex';
            }
             window.handleRecap = (aset) => {
                const assetTransactions = allTransactions.filter(tx => tx.aset === aset);
                if(assetTransactions.length === 0) return;
                ui.recapAssetCode.textContent = `Rekapitulasi: ${aset}`;
                ui.recapTable.body.innerHTML = ''; ui.recapTable.foot.innerHTML = '';
                let totalRealizedPL = 0; const buys = [];
                assetTransactions.sort((a,b) => new Date(a.tanggal) - new Date(b.tanggal)).forEach(tx => {
                    const nilai = tx.tipe === 'Dividen' ? tx.jumlah : tx.lot * 100 * tx.harga;
                    ui.recapTable.body.innerHTML += `<tr><td>${tx.tanggal}</td><td>${tx.tipe}</td><td>${tx.tipe === 'Dividen' ? '-' : tx.lot.toLocaleString('id-ID')}</td><td>${tx.tipe === 'Dividen' ? '-' : formatCurrency(tx.harga)}</td><td>${formatCurrency(nilai)}</td></tr>`;
                    if (tx.tipe === 'Beli') buys.push({ lot: tx.lot, cost: tx.lot * 100 * tx.harga + (tx.biaya || 0) });
                    else if (tx.tipe === 'Jual') {
                        let lotToSell = tx.lot, revenue = tx.lot * 100 * tx.harga - (tx.biaya || 0), costOfSoldLots = 0;
                        while (lotToSell > 0 && buys.length > 0) {
                            const firstBuy = buys[0], lotFromThisBuy = Math.min(lotToSell, firstBuy.lot), costPerLot = firstBuy.cost / firstBuy.lot;
                            costOfSoldLots += lotFromThisBuy * costPerLot;
                            firstBuy.lot -= lotFromThisBuy; firstBuy.cost -= lotFromThisBuy * costPerLot;
                            lotToSell -= lotFromThisBuy;
                            if (firstBuy.lot < 1e-7) buys.shift();
                        }
                        totalRealizedPL += revenue - costOfSoldLots;
                    } else if (tx.tipe === 'Dividen') totalRealizedPL += tx.jumlah;
                });
                const plClass = totalRealizedPL >= 0 ? 'profit' : 'loss';
                ui.recapTable.foot.innerHTML = `<tr><td colspan="3"><strong>Total P/L Realisasi</strong></td><td colspan="2" class="${plClass}"><strong>${formatCurrency(totalRealizedPL)}</strong></td></tr>`;
                ui.recapModal.style.display = 'flex';
            };

            function renderHeatmap(transactions) {
                if(!ui.heatmap.container) return;
                const plByDate = {};
                transactions.forEach(tx => {
                    if (tx.tipe !== 'Beli') {
                        const date = tx.tanggal; const pl = getRealizedPLForTx(tx, transactions);
                        plByDate[date] = (plByDate[date] || 0) + pl;
                    }
                });
                const year = currentHeatmapDate.getFullYear(), month = currentHeatmapDate.getMonth();
                ui.heatmap.navLabel.textContent = `${currentHeatmapDate.toLocaleString('id-ID', { month: 'long' })} ${year}`;
                const daysInMonth = new Date(year, month + 1, 0).getDate(), firstDayOfMonth = new Date(year, month, 1).getDay();
                let tableHTML = `<thead><tr><th>Min</th><th>Sen</th><th>Sel</th><th>Rab</th><th>Kam</th><th>Jum</th><th>Sab</th></tr></thead><tbody><tr>`;
                for (let i = 0; i < firstDayOfMonth; i++) tableHTML += `<td></td>`;
                let maxAbsPL = 0; Object.values(plByDate).forEach(pl => { if(Math.abs(pl) > maxAbsPL) maxAbsPL = Math.abs(pl); });
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const pl = plByDate[dateStr]; let cellStyle = '', plContent = '';
                    if (pl) {
                        const opacity = Math.min(Math.max(Math.abs(pl) / (maxAbsPL || 1), 0.2), 1);
                        const color = pl > 0 ? `rgba(40, 167, 69, ${opacity})` : `rgba(220, 53, 69, ${opacity})`;
                        cellStyle = `style="background-color: ${color}"`;
                        plContent = `<div class="day-pl">${formatCurrency(pl, false)}</div>`;
                    }
                    tableHTML += `<td ${cellStyle}><div class="day-number">${day}</div>${plContent}</td>`;
                    if ((firstDayOfMonth + day) % 7 === 0) tableHTML += `</tr><tr>`;
                }
                tableHTML += `</tr></tbody>`; ui.heatmap.container.innerHTML = tableHTML;
            }

            function openModal(isEdit = false, data = {}) {
                resetForm();
                ui.modalTitle.textContent = isEdit ? "Edit Transaksi" : "Tambah Transaksi Baru";
                ui.submitButton.textContent = isEdit ? "Perbarui Transaksi" : "Simpan Transaksi";
                if(isEdit) {
                    ui.transactionTypeSelect.value = data.tipe;
                    toggleTransactionFields(data.tipe);
                    document.getElementById('edit-id').value = data.id; 
                    document.getElementById('tanggal').value = data.tanggal; 
                    document.getElementById('aset').value = data.aset; 
                    if(data.tipe === 'Dividen') { document.getElementById('dividen-amount').value = data.jumlah; }
                    else { 
                        document.getElementById('lot').value = data.lot; 
                        document.getElementById('harga').value = data.harga; 
                        document.getElementById('biaya').value = data.biaya; 
                    }
                    document.getElementById('keterangan').value = data.keterangan || '';
                } else {
                    document.getElementById('tanggal').value = new Date().toISOString().split('T')[0];
                    toggleTransactionFields('Beli');
                }
                ui.transactionModal.style.display = 'flex';
            }

            function closeModal(modal) { if(modal) modal.style.display = 'none'; }
            function resetForm() { ui.transactionForm.reset(); document.getElementById('edit-id').value = ''; toggleTransactionFields('Beli'); }

            function toggleTransactionFields(type) {
                const isDividend = type === 'Dividen';
                const tradeFields = document.getElementById('trade-fields');
                const dividenGroup = document.getElementById('group-dividen');
                if(tradeFields) tradeFields.style.display = isDividend ? 'none' : 'block';
                if(dividenGroup) dividenGroup.style.display = isDividend ? 'block' : 'none';
                if (ui.lotInput && ui.hargaInput && ui.dividenAmountInput) {
                    ui.lotInput.required = !isDividend;
                    ui.hargaInput.required = !isDividend;
                    ui.dividenAmountInput.required = isDividend;
                }
            }
            
            function handleTransactionSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('edit-id').value; 
                const type = ui.transactionTypeSelect.value;
                let transactionData = { 
                    tanggal: document.getElementById('tanggal').value, 
                    aset: document.getElementById('aset').value.toUpperCase(), 
                    tipe: type, 
                    keterangan: document.getElementById('keterangan').value 
                };
                if (type === 'Dividen') {
                    transactionData.jumlah = parseFloat(ui.dividenAmountInput.value);
                } else { 
                    transactionData.lot = parseFloat(ui.lotInput.value); 
                    transactionData.harga = parseFloat(ui.hargaInput.value); 
                    transactionData.biaya = parseFloat(document.getElementById('biaya').value) || 0; 
                }
                const promise = id 
                    ? db.collection('transactions').doc(id).update({ ...transactionData, lastUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()}) 
                    : db.collection('transactions').add({ ...transactionData, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
                promise.then(() => closeModal(ui.transactionModal));
            }

            window.handleEdit = (id) => db.collection('transactions').doc(id).get().then(doc => doc.exists && openModal(true, {id, ...doc.data()}));
            window.handleDelete = (id) => confirm('Anda yakin ingin menghapus transaksi ini?') && db.collection('transactions').doc(id).delete();
            
            // CSV functions
            function downloadCSVTemplate() {
                const headers = ["tanggal", "tipe", "aset", "lot", "harga", "biaya", "jumlah"];
                const csvContent = "data:text/csv;charset=utf-8," + headers.join(";") + "\r\n";
                const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "template_jurnal.csv");
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            }
            function exportToCSV(transactions) {
                let csvContent = "data:text/csv;charset=utf-8,"; const headers = ["tanggal", "tipe", "aset", "lot", "harga", "biaya", "jumlah", "keterangan"];
                csvContent += headers.join(";") + "\r\n";
                transactions.forEach(tx => { const row = [tx.tanggal || '', tx.tipe || '', tx.aset || '', tx.lot || 0, tx.harga || 0, tx.biaya || 0, tx.jumlah || 0, tx.keterangan || '']; csvContent += row.join(";") + "\r\n"; });
                const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "jurnal_trading.csv");
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            }
            function importFromCSV(file) {
                if (!file) return; const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result; const rows = text.split('\n').slice(1);
                    csvPreviewData = []; let tableHTML = `<thead><tr><th>tanggal</th><th>tipe</th><th>aset</th><th>lot</th><th>harga</th><th>biaya</th><th>jumlah</th></tr></thead><tbody>`;
                    rows.forEach(row => {
                        if (!row) return; const columns = row.split(';');
                        const txData = { tanggal: columns[0] || '', tipe: columns[1] || '', aset: (columns[2] || '').toUpperCase(), lot: parseFloat(columns[3]) || 0, harga: parseFloat(columns[4]) || 0, biaya: parseFloat(columns[5]) || 0, jumlah: parseFloat(columns[6]) || 0, };
                        csvPreviewData.push(txData); tableHTML += `<tr>${Object.values(txData).map(val => `<td>${val}</td>`).join('')}</tr>`;
                    });
                    tableHTML += `</tbody>`; ui.importPreview.table.innerHTML = tableHTML; ui.importPreviewModal.style.display = 'flex';
                };
                reader.readAsText(file); ui.importInput.value = '';
            }
            function confirmImport() {
                if (csvPreviewData.length === 0) return alert('Tidak ada data untuk diimpor.');
                const batch = db.batch();
                csvPreviewData.forEach(txData => { const docRef = db.collection("transactions").doc(); batch.set(docRef, {...txData, createdAt: firebase.firestore.FieldValue.serverTimestamp()}); });
                batch.commit().then(() => { alert('Impor CSV berhasil!'); closeModal(ui.importPreviewModal); }).catch(err => { alert('Gagal mengimpor data.'); console.error(err); });
            }
            function handleBulkDelete() {
                const checkedCheckboxes = document.querySelectorAll('.history-checkbox:checked');
                if (checkedCheckboxes.length === 0) return alert('Pilih transaksi yang ingin dihapus.');
                if (!confirm(`Anda yakin ingin menghapus ${checkedCheckboxes.length} transaksi terpilih?`)) return;
                const batch = db.batch();
                checkedCheckboxes.forEach(cb => { const docId = cb.dataset.id; const docRef = db.collection('transactions').doc(docId); batch.delete(docRef); });
                batch.commit().then(() => { alert('Transaksi terpilih berhasil dihapus.'); ui.deleteSelectedBtn.style.display = 'none'; }).catch(err => { alert('Gagal menghapus transaksi.'); console.error(err); });
            }

            // --- MAIN EXECUTION ---
            setupEventListeners();
            initializeAndSyncData();
            updateThemeUI(localStorage.getItem('theme') || 'dark-mode');
            // Set default date for forward test form
            if(document.getElementById('ft-tanggal')) {
                document.getElementById('ft-tanggal').value = new Date().toISOString().split('T')[0];
            }
        });
    </script>
</body>
</html>
